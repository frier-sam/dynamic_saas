{% extends 'base.html' %}

{% block title %}{{ module.name }}{% endblock %}

{% block page_title %}{{ module.name }}{% endblock %}

{% block header_actions %}
    <div class="flex items-center space-x-3">
        <a href="{% url 'conversation_detail' conversation.id %}" class="text-blue-500 hover:text-blue-700">
            <i class="fas fa-comment-alt mr-1"></i> Chat
        </a>
        
        <button id="edit-module-btn" class="text-blue-500 hover:text-blue-700">
            <i class="fas fa-edit mr-1"></i> Edit
        </button>
        
        <button id="delete-module-btn" class="text-red-500 hover:text-red-700">
            <i class="fas fa-trash-alt mr-1"></i> Delete
        </button>
    </div>
{% endblock %}

{% block content %}
<div class="h-full">
    <!-- Module Information -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between">
            <div class="mb-4 md:mb-0">
                <h2 class="text-2xl font-bold mb-2">{{ module.name }}</h2>
                <p class="text-gray-500 mb-4">
                    <span class="mr-3">
                        <i class="fas fa-calendar-alt mr-1"></i> Created {{ module.created_at|date:"M d, Y" }}
                    </span>
                    <span class="mr-3">
                        <i class="fas fa-sync-alt mr-1"></i> Updated {{ module.updated_at|date:"M d, Y" }}
                    </span>
                    <span>
                        <i class="fas fa-eye mr-1"></i> Used {{ module.state.usage_count }} times
                    </span>
                </p>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    <span class="inline-block bg-blue-100 text-blue-800 text-sm px-2.5 py-0.5 rounded-full">
                        {{ module.get_module_type_display }}
                    </span>
                    {% if module.has_gui %}
                        <span class="inline-block bg-green-100 text-green-800 text-sm px-2.5 py-0.5 rounded-full">
                            <i class="fas fa-desktop mr-1"></i> Has UI
                        </span>
                    {% endif %}
                </div>
                
                <div class="prose prose-sm max-w-none">
                    {% if module.description %}
                        <p>{{ module.description }}</p>
                    {% else %}
                        <p class="text-gray-400 italic">No description</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="flex flex-col space-y-2">
                {% if module.has_gui %}
                    <button id="view-ui-btn" class="bg-blue-500 hover:bg-blue-600 text-white rounded-md px-4 py-2 text-sm flex items-center justify-center">
                        <i class="fas fa-desktop mr-1"></i> View UI
                    </button>
                {% else %}
                    <button id="generate-ui-btn" class="bg-green-500 hover:bg-green-600 text-white rounded-md px-4 py-2 text-sm flex items-center justify-center">
                        <i class="fas fa-magic mr-1"></i> Generate UI
                    </button>
                {% endif %}
                
                <button id="add-data-btn" class="bg-purple-500 hover:bg-purple-600 text-white rounded-md px-4 py-2 text-sm flex items-center justify-center">
                    <i class="fas fa-plus mr-1"></i> Add Data
                </button>
                
                <a href="{% url 'conversation_detail' conversation.id %}" class="bg-gray-500 hover:bg-gray-600 text-white rounded-md px-4 py-2 text-sm flex items-center justify-center">
                    <i class="fas fa-comment-alt mr-1"></i> Chat with Module
                </a>
            </div>
        </div>
    </div>
    
    <!-- Tables Section -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium">Database Tables</h3>
            <button id="create-table-btn" class="text-blue-500 hover:text-blue-700 text-sm">
                <i class="fas fa-plus mr-1"></i> Add Table
            </button>
        </div>
        
        {% if tables %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for table in tables %}
                    <div class="border border-gray-200 rounded-md overflow-hidden">
                        <div class="bg-gray-50 p-3 border-b border-gray-200 flex items-center justify-between">
                            <h4 class="font-medium">{{ table.name }}</h4>
                            <div class="flex space-x-2">
                                <button class="view-table-data text-blue-500 hover:text-blue-700" data-table-id="{{ table.id }}" data-table-name="{{ table.name }}">
                                    <i class="fas fa-table"></i>
                                </button>
                                <button class="view-table-schema text-blue-500 hover:text-blue-700" data-table-id="{{ table.id }}" data-table-name="{{ table.name }}">
                                    <i class="fas fa-code"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-3">
                            <p class="text-sm text-gray-500">
                                {% if table.description %}
                                    {{ table.description }}
                                {% else %}
                                    <span class="italic">No description</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-8 bg-gray-50 rounded-md">
                <div class="text-gray-400 mb-3">
                    <i class="fas fa-table text-3xl"></i>
                </div>
                <h4 class="text-lg font-medium mb-2">No tables yet</h4>
                <p class="text-gray-500 mb-4">Create tables by chatting with the AI or use the button above.</p>
                <a href="{% url 'conversation_detail' conversation.id %}" class="inline-block bg-blue-500 hover:bg-blue-600 text-white rounded-md px-4 py-2 text-sm">
                    <i class="fas fa-comment-alt mr-1"></i> Chat with Module
                </a>
            </div>
        {% endif %}
    </div>
    
    <!-- Module UI Section -->
    <div id="module-ui-section" class="bg-white rounded-lg border border-gray-200 p-6{% if not module.has_gui %} hidden{% endif %}">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium">Module UI</h3>
            <button id="edit-ui-btn" class="text-blue-500 hover:text-blue-700 text-sm">
                <i class="fas fa-edit mr-1"></i> Edit UI
            </button>
        </div>
        
        <div id="module-ui-container" class="border border-gray-200 rounded-md overflow-hidden">
            <div class="bg-gray-50 p-3 border-b border-gray-200">
                <h4 class="font-medium">UI Preview</h4>
            </div>
            <div id="module-ui-preview" class="p-6">
                <!-- UI will be loaded here -->
                <div class="text-center py-8">
                    <div class="text-gray-400 animate-spin mb-3">
                        <i class="fas fa-spinner text-3xl"></i>
                    </div>
                    <p class="text-gray-500">Loading UI...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Table Data Modal -->
    <div id="table-data-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg max-w-5xl w-full max-h-screen overflow-hidden flex flex-col">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 id="table-data-title" class="text-lg font-medium">Table Data</h2>
                <button id="close-table-data" class="text-gray-500 hover:text-red-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="table-data-content" class="p-6 overflow-auto flex-grow">
                <!-- Table data will be loaded here -->
                <div class="text-center py-8">
                    <div class="text-gray-400 animate-spin mb-3">
                        <i class="fas fa-spinner text-3xl"></i>
                    </div>
                    <p class="text-gray-500">Loading data...</p>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end">
                <button id="add-record-btn" class="bg-blue-500 hover:bg-blue-600 text-white rounded-md px-4 py-2 text-sm flex items-center">
                    <i class="fas fa-plus mr-1"></i> Add Record
                </button>
            </div>
        </div>
    </div>
    
    <!-- Table Schema Modal -->
    <div id="table-schema-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 id="table-schema-title" class="text-lg font-medium">Table Schema</h2>
                <button id="close-table-schema" class="text-gray-500 hover:text-red-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="table-schema-content" class="p-6 max-h-96 overflow-y-auto">
                <!-- Schema will be loaded here -->
                <div class="text-center py-8">
                    <div class="text-gray-400 animate-spin mb-3">
                        <i class="fas fa-spinner text-3xl"></i>
                    </div>
                    <p class="text-gray-500">Loading schema...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Module Modal -->
    <div id="edit-module-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg max-w-lg w-full">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-lg font-medium">Edit Module</h2>
                <button id="close-edit-module" class="text-gray-500 hover:text-red-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="edit-module-form">
                    <div class="mb-4">
                        <label for="edit-module-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="edit-module-name" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               value="{{ module.name }}">
                    </div>
                    
                    <div class="mb-4">
                        <label for="edit-module-type" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="edit-module-type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="data" {% if module.module_type == 'data' %}selected{% endif %}>Data Management</option>
                            <option value="form" {% if module.module_type == 'form' %}selected{% endif %}>Form Interface</option>
                            <option value="report" {% if module.module_type == 'report' %}selected{% endif %}>Reporting</option>
                            <option value="dashboard" {% if module.module_type == 'dashboard' %}selected{% endif %}>Dashboard</option>
                            <option value="custom" {% if module.module_type == 'custom' %}selected{% endif %}>Custom Type</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="edit-module-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="edit-module-description" rows="4" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">{{ module.description }}</textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-edit-module" class="bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-md px-4 py-2">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white rounded-md px-4 py-2">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Delete Module Confirmation Modal -->
    <div id="delete-module-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-lg font-medium">Delete Module</h2>
                <button id="close-delete-module" class="text-gray-500 hover:text-red-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-gray-700 mb-4">Are you sure you want to delete <strong>{{ module.name }}</strong>? This action cannot be undone.</p>
                <p class="text-red-500 mb-4">All data, tables, and UI associated with this module will be permanently deleted.</p>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete-module" class="bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-md px-4 py-2">
                        Cancel
                    </button>
                    <button id="confirm-delete-module" class="bg-red-500 hover:bg-red-600 text-white rounded-md px-4 py-2">
                        Delete Module
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Module UI Modal -->
    <div id="module-ui-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg max-w-6xl w-full h-5/6 flex flex-col">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-lg font-medium">{{ module.name }} - UI</h2>
                <button id="close-module-ui-modal" class="text-gray-500 hover:text-red-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="module-ui-iframe-container" class="flex-grow overflow-hidden">
                <iframe id="module-ui-iframe" class="w-full h-full border-0" src="about:blank"></iframe>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Store the module ID for API calls
    const moduleId = {{ module.id }};
    
    // Edit module
    document.getElementById('edit-module-btn').addEventListener('click', () => {
        document.getElementById('edit-module-modal').classList.remove('hidden');
    });
    
    document.getElementById('close-edit-module').addEventListener('click', () => {
        document.getElementById('edit-module-modal').classList.add('hidden');
    });
    
    document.getElementById('cancel-edit-module').addEventListener('click', () => {
        document.getElementById('edit-module-modal').classList.add('hidden');
    });
    
    document.getElementById('edit-module-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('edit-module-name').value.trim();
        const moduleType = document.getElementById('edit-module-type').value;
        const description = document.getElementById('edit-module-description').value.trim();
        
        if (!name) {
            alert('Module name is required');
            return;
        }
        
        try {
            const response = await fetch(`/modules/api/modules/${moduleId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    name,
                    module_type: moduleType,
                    description
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update module');
            }
            
            // Hide modal
            document.getElementById('edit-module-modal').classList.add('hidden');
            
            // Reload the page to show updated info
            window.location.reload();
            
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to update module');
        }
    });
    
    // Delete module
    document.getElementById('delete-module-btn').addEventListener('click', () => {
        document.getElementById('delete-module-modal').classList.remove('hidden');
    });
    
    document.getElementById('close-delete-module').addEventListener('click', () => {
        document.getElementById('delete-module-modal').classList.add('hidden');
    });
    
    document.getElementById('cancel-delete-module').addEventListener('click', () => {
        document.getElementById('delete-module-modal').classList.add('hidden');
    });
    
    document.getElementById('confirm-delete-module').addEventListener('click', async () => {
        try {
            const response = await fetch(`/modules/api/modules/${moduleId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete module');
            }
            
            // Redirect to modules list
            window.location.href = '{% url "module_list" %}';
            
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to delete module');
        }
    });
    
    // View table data
    document.querySelectorAll('.view-table-data').forEach(button => {
        button.addEventListener('click', async (e) => {
            const tableId = e.target.closest('.view-table-data').dataset.tableId;
            const tableName = e.target.closest('.view-table-data').dataset.tableName;
            
            // Show modal
            document.getElementById('table-data-modal').classList.remove('hidden');
            document.getElementById('table-data-title').textContent = `${tableName} Data`;
            
            // Set the current table name for adding records
            document.getElementById('add-record-btn').dataset.tableName = tableName;
            
            try {
                // Fetch table data
                const response = await fetch(`/modules/api/modules/${moduleId}/data/${tableName}/`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch table data');
                }
                
                const data = await response.json();
                
                // Render table data
                const tableDataContent = document.getElementById('table-data-content');
                
                if (data.length === 0) {
                    tableDataContent.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-gray-400 mb-3">
                                <i class="fas fa-database text-3xl"></i>
                            </div>
                            <h4 class="text-lg font-medium mb-2">No data yet</h4>
                            <p class="text-gray-500">Add records to see data in this table.</p>
                        </div>
                    `;
                    return;
                }
                
                // Get column names from the first row
                const columns = Object.keys(data[0]);
                
                // Create table HTML
                let tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                `;
                
                // Add column headers
                columns.forEach(column => {
                    tableHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${column}</th>`;
                });
                
                // Add actions column
                tableHtml += `<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>`;
                
                tableHtml += `
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                // Add rows
                data.forEach(row => {
                    tableHtml += `<tr>`;
                    
                    // Add cells
                    columns.forEach(column => {
                        let displayValue = row[column] !== null ? row[column] : '';
                        
                        // Format boolean values
                        if (typeof displayValue === 'boolean') {
                            displayValue = displayValue ? 
                                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Yes</span>' : 
                                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">No</span>';
                        }
                        
                        tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayValue}</td>`;
                    });
                    
                    // Add actions
                    tableHtml += `
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="edit-record text-blue-500 hover:text-blue-700 mr-3" data-record-id="${row.id}" data-table-name="${tableName}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-record text-red-500 hover:text-red-700" data-record-id="${row.id}" data-table-name="${tableName}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    
                    tableHtml += `</tr>`;
                });
                
                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                tableDataContent.innerHTML = tableHtml;
                
                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-record').forEach(button => {
                    button.addEventListener('click', (e) => {
                        // TODO: Implement record editing
                        alert('Edit record feature coming soon!');
                    });
                });
                
                document.querySelectorAll('.delete-record').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        if (confirm('Are you sure you want to delete this record?')) {
                            const recordId = e.target.closest('.delete-record').dataset.recordId;
                            const tableName = e.target.closest('.delete-record').dataset.tableName;
                            
                            try {
                                const response = await fetch(`/modules/api/modules/${moduleId}/data/${tableName}/${recordId}/`, {
                                    method: 'DELETE',
                                    headers: {
                                        'X-CSRFToken': getCSRFToken()
                                    }
                                });
                                
                                if (!response.ok) {
                                    throw new Error('Failed to delete record');
                                }
                                
                                // Remove the row from the table
                                e.target.closest('tr').remove();
                                
                            } catch (error) {
                                console.error('Error:', error);
                                alert('Failed to delete record');
                            }
                        }
                    });
                });
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('table-data-content').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-400 mb-3">
                            <i class="fas fa-exclamation-circle text-3xl"></i>
                        </div>
                        <h4 class="text-lg font-medium mb-2">Error</h4>
                        <p class="text-gray-500">Failed to load table data. Please try again.</p>
                    </div>
                `;
            }
        });
    });
    
    // Close table data modal
    document.getElementById('close-table-data').addEventListener('click', () => {
        document.getElementById('table-data-modal').classList.add('hidden');
    });
    
    // View table schema
    document.querySelectorAll('.view-table-schema').forEach(button => {
        button.addEventListener('click', async (e) => {
            const tableId = e.target.closest('.view-table-schema').dataset.tableId;
            const tableName = e.target.closest('.view-table-schema').dataset.tableName;
            
            // Show modal
            document.getElementById('table-schema-modal').classList.remove('hidden');
            document.getElementById('table-schema-title').textContent = `${tableName} Schema`;
            
            try {
                // Fetch module details to get table schema
                const response = await fetch(`/modules/api/modules/${moduleId}/`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch module details');
                }
                
                const moduleData = await response.json();
                
                // Find the table
                const table = moduleData.tables.find(t => t.name === tableName);
                
                if (!table) {
                    throw new Error('Table not found');
                }
                
                // Render schema
                const schemaContent = document.getElementById('table-schema-content');
                
                // Get fields from schema
                const schema = table.schema;
                const fields = schema.fields;
                
                if (!fields || Object.keys(fields).length === 0) {
                    schemaContent.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-gray-400 mb-3">
                                <i class="fas fa-exclamation-circle text-3xl"></i>
                            </div>
                            <h4 class="text-lg font-medium mb-2">No Schema Available</h4>
                            <p class="text-gray-500">This table doesn't have a defined schema.</p>
                        </div>
                    `;
                    return;
                }
                
                // Create schema HTML
                let schemaHtml = `
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Physical Table Name</h4>
                        <code class="block bg-gray-100 p-2 rounded">${schema.physical_name}</code>
                    </div>
                    
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Fields</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Field Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Type</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                // Add field rows
                Object.entries(fields).forEach(([fieldName, fieldType]) => {
                    schemaHtml += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fieldName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fieldType}</td>
                        </tr>
                    `;
                });
                
                schemaHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                schemaContent.innerHTML = schemaHtml;
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('table-schema-content').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-400 mb-3">
                            <i class="fas fa-exclamation-circle text-3xl"></i>
                        </div>
                        <h4 class="text-lg font-medium mb-2">Error</h4>
                        <p class="text-gray-500">Failed to load schema. Please try again.</p>
                    </div>
                `;
            }
        });
    });
    
    // Close table schema modal
    document.getElementById('close-table-schema').addEventListener('click', () => {
        document.getElementById('table-schema-modal').classList.add('hidden');
    });
    
    // Generate UI
    document.getElementById('generate-ui-btn')?.addEventListener('click', async () => {
        // Disable button to prevent multiple clicks
        document.getElementById('generate-ui-btn').disabled = true;
        document.getElementById('generate-ui-btn').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Generating...';
        
        try {
            const response = await fetch(`/modules/api/modules/${moduleId}/generate_ui/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to generate UI');
            }
            
            // Reload the page to show new UI
            window.location.reload();
            
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to generate UI');
            
            // Re-enable button
            document.getElementById('generate-ui-btn').disabled = false;
            document.getElementById('generate-ui-btn').innerHTML = '<i class="fas fa-magic mr-1"></i> Generate UI';
        }
    });
    
    // View UI
    document.getElementById('view-ui-btn')?.addEventListener('click', () => {
        document.getElementById('module-ui-modal').classList.remove('hidden');
        
        // Load UI in iframe
        const iframe = document.getElementById('module-ui-iframe');
        
        iframe.srcdoc = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <script src="https://cdn.tailwindcss.com"></`+`script>
                <title>${module.name} UI</title>
            </head>
            <body class="bg-gray-50 p-6">
                <h1 class="text-2xl font-bold mb-6">${module.name}</h1>
                
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h2 class="text-lg font-medium mb-4">Module Interface</h2>
                    <p class="text-gray-500 mb-4">This is a placeholder for the module's UI. In a real implementation, the UI would be dynamically generated based on the module's schema and UI definition.</p>
                    
                    <div class="bg-blue-50 p-4 rounded-md border border-blue-200">
                        <p class="text-blue-800">This UI would typically include forms, tables, buttons, and other components to interact with the module's data.</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-medium mb-3">Data Entry</h3>
                        <form id="demoForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Sample Field 1</label>
                                <input type="text" name="field1" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter value...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Sample Field 2</label>
                                <input type="text" name="field2" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter value...">
                            </div>
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">Submit</button>
                        </form>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-medium mb-3">Recent Data</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Field 1</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Field 2</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">1</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">Sample Value 1</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">Sample Value 2</td>
                                    </tr>
                                    <tr>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">2</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">Another Value 1</td>
                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">Another Value 2</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <script>
                    // Handle form submission
                    document.getElementById('demoForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        // Get form data
                        const formData = new FormData(e.target);
                        const data = {};
                        for (let [key, value] of formData.entries()) {
                            data[key] = value;
                        }
                        
                        // Show success message (in real implementation, you'd send this to your backend)
                        alert('Form submitted successfully with data: ' + JSON.stringify(data));
                        
                        // Clear form
                        e.target.reset();
                    });
                </`+`script>
            </body>
            </html>
        `;
    });
    
    // Close UI modal
    document.getElementById('close-module-ui-modal').addEventListener('click', () => {
        document.getElementById('module-ui-modal').classList.add('hidden');
    });
    
    // Add record
    document.getElementById('add-record-btn').addEventListener('click', () => {
        // In a real implementation, you'd show a form to add a record
        alert('Add record feature coming soon!');
    });
    
    // Create table
    document.getElementById('create-table-btn').addEventListener('click', () => {
        // Redirect to chat to have the AI create a table
        window.location.href = "{% url 'conversation_detail' conversation.id %}";
    });
    
    // Add data button
    document.getElementById('add-data-btn').addEventListener('click', () => {
        // Redirect to chat to have the AI add data
        window.location.href = "{% url 'conversation_detail' conversation.id %}";
    });
    
    // Edit UI button
    document.getElementById('edit-ui-btn')?.addEventListener('click', () => {
        // Redirect to chat to have the AI modify the UI
        window.location.href = "{% url 'conversation_detail' conversation.id %}";
    });
    
    // Load UI preview if module has GUI
    {% if module.has_gui %}
    (async () => {
        try {
            // Fetch module details to get UI definition
            const response = await fetch(`/modules/api/modules/${moduleId}/`);
            
            if (!response.ok) {
                throw new Error('Failed to fetch module details');
            }
            
            const moduleData = await response.json();
            
            // Get UI definition
            const uiDefinition = moduleData.ui_definition;
            
            if (!uiDefinition) {
                throw new Error('No UI definition found');
            }
            
            // Get table information
            const tables = moduleData.tables;
            const tableMap = {};
            tables.forEach(table => {
                tableMap[table.name] = table;
            });
            
            // Render UI preview
            const uiPreview = document.getElementById('module-ui-preview');
            
            // Build the UI based on the definition
            let uiHtml = `
                <div class="bg-white p-4 rounded-md border border-gray-200">
                    <h3 class="text-xl font-medium mb-6">${uiDefinition.title || module.name}</h3>
            `;
            
            // Add tabbed navigation if there are multiple sections
            if (uiDefinition.sections && uiDefinition.sections.length > 1) {
                uiHtml += `
                    <div class="mb-6">
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                `;
                
                uiDefinition.sections.forEach((section, index) => {
                    uiHtml += `
                        <a href="#" class="section-tab ${index === 0 ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-section="${index}">
                            ${section.title}
                        </a>
                    `;
                });
                
                uiHtml += `
                            </nav>
                        </div>
                    </div>
                `;
            }
            
            // Add each section
            if (uiDefinition.sections && uiDefinition.sections.length > 0) {
                uiDefinition.sections.forEach((section, sectionIndex) => {
                    const isVisible = sectionIndex === 0;
                    const targetTable = section.target_table || (tables.length > 0 ? tables[0].name : '');
                    const displayStyle = isVisible ? 'block' : 'none';
                    
                    uiHtml += `
                        <div class="section-content mb-8" id="section-${sectionIndex}" style="display: ${displayStyle};" data-table="${targetTable}">
                            <h4 class="text-lg font-medium mb-2">${section.title}</h4>
                            ${section.description ? `<p class="text-gray-500 mb-4">${section.description}</p>` : ''}
                    `;
                    
                    // Add filters if any
                    if (section.filters && section.filters.length > 0) {
                        uiHtml += `
                            <div class="bg-gray-50 p-4 rounded-md mb-4">
                                <h5 class="text-sm font-medium text-gray-700 mb-3">Filters</h5>
                                <div class="flex flex-wrap gap-4">
                        `;
                        
                        section.filters.forEach((filter, filterIndex) => {
                            const filterId = `filter_${sectionIndex}_${filterIndex}`;
                            
                            if (filter.type === 'select') {
                                uiHtml += `
                                    <div class="w-full sm:w-auto">
                                        <label for="${filterId}" class="block text-sm font-medium text-gray-700">${filter.label}</label>
                                        <select id="${filterId}" name="${filterId}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md filter-control" data-target="${filter.target_field}">
                                            <option value="">All</option>
                                            <!-- Filter options will be loaded dynamically -->
                                        </select>
                                    </div>
                                `;
                            } else if (filter.type === 'text') {
                                uiHtml += `
                                    <div class="w-full sm:w-auto">
                                        <label for="${filterId}" class="block text-sm font-medium text-gray-700">${filter.label}</label>
                                        <div class="mt-1 flex rounded-md shadow-sm">
                                            <input type="text" id="${filterId}" name="${filterId}" class="focus:ring-blue-500 focus:border-blue-500 flex-1 block w-full rounded-md sm:text-sm border-gray-300 filter-control" data-target="${filter.target_field}">
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        uiHtml += `
                                    <div class="w-full sm:w-auto self-end mt-4 sm:mt-0">
                                        <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 filter-apply-btn">
                                            Apply Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Add section content based on type
                    if (section.type === 'form') {
                        uiHtml += `<form class="section-form space-y-4" data-section="${sectionIndex}" data-table="${targetTable}">`;
                        
                        // Group components into a grid for forms
                        uiHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                        
                        if (section.components && section.components.length > 0) {
                            section.components.forEach((component, compIndex) => {
                                const fieldId = `field_${sectionIndex}_${compIndex}`;
                                const dbField = component.field || `field_${sectionIndex}_${compIndex}`;
                                
                                uiHtml += `
                                    <div class="form-group">
                                        <label for="${fieldId}" class="block text-sm font-medium text-gray-700 mb-1">
                                            ${component.label}
                                            ${component.required ? '<span class="text-red-500">*</span>' : ''}
                                        </label>
                                `;
                                
                                if (component.type === 'text_input') {
                                    uiHtml += `
                                        <input type="text" id="${fieldId}" name="${dbField}" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="${component.placeholder || ''}" 
                                               ${component.required ? 'required' : ''}>
                                    `;
                                } else if (component.type === 'number_input') {
                                    uiHtml += `
                                        <input type="number" id="${fieldId}" name="${dbField}" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="${component.placeholder || ''}" 
                                               ${component.required ? 'required' : ''}>
                                    `;
                                } else if (component.type === 'select') {
                                    uiHtml += `
                                        <select id="${fieldId}" name="${dbField}" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                                ${component.required ? 'required' : ''}>
                                            <option value="">Select...</option>
                                    `;

                                    // If this is a relationship field (like category_id), load options
                                    if (component.options && component.options.source_table) {
                                        uiHtml += `<!-- Options will be loaded from ${component.options.source_table} -->`;
                                    } else if (component.options) {
                                        // Static options
                                        component.options.forEach(opt => {
                                            uiHtml += `<option value="${opt.value}">${opt.label}</option>`;
                                        });
                                    }
                                    
                                    uiHtml += `</select>`;
                                } else if (component.type === 'checkbox') {
                                    uiHtml += `
                                        <div class="flex items-center">
                                            <input type="checkbox" id="${fieldId}" name="${dbField}" class="h-4 w-4 text-blue-600 rounded" 
                                                   ${component.required ? 'required' : ''}>
                                            <span class="ml-2 text-sm text-gray-700">${component.placeholder || ''}</span>
                                        </div>
                                    `;
                                } else if (component.type === 'textarea') {
                                    uiHtml += `
                                        <textarea id="${fieldId}" name="${dbField}" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                                  placeholder="${component.placeholder || ''}" 
                                                  rows="3"
                                                  ${component.required ? 'required' : ''}></textarea>
                                    `;
                                } else if (component.type === 'date') {
                                    uiHtml += `
                                        <input type="date" id="${fieldId}" name="${dbField}" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               ${component.required ? 'required' : ''}>
                                    `;
                                } else {
                                    uiHtml += `
                                        <input type="text" id="${fieldId}" name="${dbField}" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="Unknown component type" disabled>
                                    `;
                                }
                                
                                uiHtml += `</div>`;
                            });
                        } else {
                            uiHtml += `<p class="text-gray-500 col-span-2">No components in this section</p>`;
                        }
                        
                        uiHtml += `</div>`; // Close grid
                        
                        // Add form actions/buttons
                        if (section.actions && section.actions.length > 0) {
                            uiHtml += `
                                <div class="pt-4 flex justify-end space-x-3">
                            `;
                            
                            section.actions.forEach((action, actionIndex) => {
                                let buttonClass = 'bg-gray-100 hover:bg-gray-200 text-gray-800';
                                
                                if (action.style === 'primary') {
                                    buttonClass = 'bg-blue-500 hover:bg-blue-600 text-white';
                                } else if (action.style === 'danger') {
                                    buttonClass = 'bg-red-500 hover:bg-red-600 text-white';
                                } else if (action.style === 'success') {
                                    buttonClass = 'bg-green-500 hover:bg-green-600 text-white';
                                }
                                
                                uiHtml += `
                                    <button type="submit" class="${buttonClass} rounded-md px-4 py-2 submit-btn" data-action="${action.action || 'save'}">
                                        ${action.label}
                                    </button>
                                `;
                            });
                            
                            uiHtml += `
                                </div>
                            `;
                        } else {
                            uiHtml += `
                                <div class="pt-4 flex justify-end">
                                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white rounded-md px-4 py-2 submit-btn" data-action="save">
                                        Save
                                    </button>
                                </div>
                            `;
                        }
                        
                        uiHtml += `</form>`; // Close form
                    } else if (section.type === 'display') {
                        // Data display section (e.g. for listing records)
                        uiHtml += `
                            <div class="bg-white rounded-md border border-gray-200 overflow-hidden display-section" data-table="${targetTable}">
                                <div class="px-4 py-5 sm:p-6">
                                    <div class="data-display-container">
                                        <div class="text-center py-10">
                                            <div class="text-gray-400 mb-3">
                                                <i class="fas fa-spinner fa-spin text-2xl"></i>
                                            </div>
                                            <p class="text-gray-500">Loading data...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    uiHtml += `</div>`; // Close section content
                });
            } else {
                uiHtml += `<p class="text-gray-500">No sections defined in this UI</p>`;
            }
            
            uiHtml += `</div>`; // Close main container
            
            uiPreview.innerHTML = uiHtml;
            
            // Setup event handlers for the UI
            setupUIEventHandlers();
            
            // Load any initial data
            loadDisplaySections();
            
            // Load options for select dropdowns
            loadSelectOptions();
            
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('module-ui-preview').innerHTML = `
                <div class="text-center py-8">
                    <div class="text-red-400 mb-3">
                        <i class="fas fa-exclamation-circle text-3xl"></i>
                    </div>
                    <h4 class="text-lg font-medium mb-2">Error</h4>
                    <p class="text-gray-500">Failed to load UI preview. Please try again.</p>
                </div>
            `;
        }
    })();
    {% endif %}

    // Function to set up event handlers for the UI
    function setupUIEventHandlers() {
        // Tab switching
        document.querySelectorAll('.section-tab').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Get the target section
                const sectionIndex = this.dataset.section;
                
                // Hide all sections
                document.querySelectorAll('.section-content').forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show the target section
                document.getElementById(`section-${sectionIndex}`).style.display = 'block';
                
                // Update active tab styling
                document.querySelectorAll('.section-tab').forEach(t => {
                    t.classList.remove('border-blue-500', 'text-blue-600');
                    t.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });
                
                this.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                this.classList.add('border-blue-500', 'text-blue-600');
            });
        });
        
        // Form submissions
        document.querySelectorAll('.section-form').forEach(form => {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Get form details
                const sectionIndex = this.dataset.section;
                const targetTable = this.dataset.table;
                
                if (!targetTable) {
                    alert('No target table specified for this form');
                    return;
                }
                
                // Collect form data
                const formData = {};
                const inputs = this.querySelectorAll('input, select, textarea');
                
                inputs.forEach(input => {
                    if (input.name) {
                        if (input.type === 'checkbox') {
                            formData[input.name] = input.checked;
                        } else if (input.type === 'number') {
                            // Convert to number if not empty
                            formData[input.name] = input.value.trim() === '' ? null : Number(input.value);
                        } else {
                            formData[input.name] = input.value;
                        }
                    }
                });
                
                try {
                    // Show loading state on submit button
                    const submitBtn = e.submitter || this.querySelector('.submit-btn');
                    const originalBtnText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Saving...';
                    
                    // Submit data to the API
                    const response = await fetch(`/modules/api/modules/${moduleId}/data/${targetTable}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to save data');
                    }
                    
                    // Show success message
                    showNotification('Data saved successfully!', 'success');
                    
                    // Reset form
                    this.reset();
                    
                    // Refresh display sections
                    loadDisplaySections();
                    
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('Error saving data. Please try again.', 'error');
                } finally {
                    // Restore submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });
        });
        
        // Filter application
        document.querySelectorAll('.filter-apply-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filterSection = this.closest('.bg-gray-50');
                const sectionContent = filterSection.closest('.section-content');
                const displaySection = sectionContent.querySelector('.display-section');
                
                if (displaySection) {
                    loadSectionData(displaySection);
                }
            });
        });
    }

    // Function to load select options from related tables
    // Function to load select options from related tables
async function loadSelectOptions() {
    try {
        // First, fetch the module details to get UI definition
        const moduleResponse = await fetch(`/modules/api/modules/${moduleId}/`);
        if (!moduleResponse.ok) {
            throw new Error('Failed to fetch module details');
        }
        const moduleData = await moduleResponse.json();
        const uiDefinition = moduleData.ui_definition;

        // Process all select elements
        const selects = document.querySelectorAll('select');
        
        for (const select of selects) {
            if (!select.name) continue;
            
            // First try to find the component in the UI definition to get source_table
            let sourceTable = null;
            let valueField = 'id';
            let labelField = 'name';
            
            if (uiDefinition && uiDefinition.sections) {
                // Look through all form sections and components
                for (const section of uiDefinition.sections) {
                    if (section.type === 'form' && section.components) {
                        // Find the component that matches this select
                        const component = section.components.find(c => c.field === select.name);
                        if (component && component.type === 'select' && component.options) {
                            // If the component has a source_table defined
                            if (component.options.source_table) {
                                sourceTable = component.options.source_table;
                                valueField = component.options.value_field || 'id';
                                labelField = component.options.label_field || 'name';
                                break;
                            }
                        }
                    }
                }
            }
            
            // If no source table was found in UI definition but field ends with _id
            if (!sourceTable && select.name.endsWith('_id')) {
                sourceTable = select.name.slice(0, -3); // Remove '_id'
            }
            
            // If we found a source table, fetch its data
            if (sourceTable) {
                try {
                    console.log(`Loading options for ${select.name} from ${sourceTable}`);
                    const response = await fetch(`/modules/api/modules/${moduleId}/data/${sourceTable}/`);
                    
                    if (!response.ok) {
                        continue; // Skip if we can't load options
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        // Add options for each record
                        data.forEach(record => {
                            const option = document.createElement('option');
                            option.value = record[valueField];
                            
                            // Use specified label field if available
                            if (record[labelField] !== undefined) {
                                option.textContent = record[labelField];
                            } else if (record.name !== undefined) {
                                option.textContent = record.name;
                            } else {
                                // Find first usable field for display
                                const firstField = Object.keys(record).find(key => 
                                    key !== 'id' && key !== 'created_at' && key !== 'updated_at');
                                option.textContent = firstField ? record[firstField] : `Record ${record.id}`;
                            }
                            select.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error(`Error loading options for ${select.name} from ${sourceTable}:`, error);
                }
            }
        }
    } catch (error) {
        console.error('Error loading select options:', error);
    }
}

    // Function to load data for display sections
    function loadDisplaySections() {
        document.querySelectorAll('.display-section').forEach(section => {
            loadSectionData(section);
        });
    }

    // Function to load data for a specific section
    function loadSectionData(section) {
        const targetTable = section.dataset.table;
        if (!targetTable) return;
        
        // Get any active filters
        const sectionContent = section.closest('.section-content');
        const filters = {};
        
        if (sectionContent) {
            sectionContent.querySelectorAll('.filter-control').forEach(filter => {
                if (filter.value) {
                    filters[filter.dataset.target] = filter.value;
                }
            });
        }
        
        // Build query parameters from filters
        let queryParams = '';
        if (Object.keys(filters).length > 0) {
            const whereConditions = [];
            const whereParams = [];
            
            for (const [field, value] of Object.entries(filters)) {
                whereConditions.push(`${field} = ?`);
                whereParams.push(value);
            }
            
            queryParams = `?where=${encodeURIComponent(whereConditions.join(' AND '))}&params=${encodeURIComponent(JSON.stringify(whereParams))}`;
        }
        
        // Show loading state
        const container = section.querySelector('.data-display-container');
        container.innerHTML = `
            <div class="text-center py-10">
                <div class="text-gray-400 mb-3">
                    <i class="fas fa-spinner fa-spin text-2xl"></i>
                </div>
                <p class="text-gray-500">Loading data...</p>
            </div>
        `;
        
        // Fetch data from the API
        fetch(`/modules/api/modules/${moduleId}/data/${targetTable}/${queryParams}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                return response.json();
            })
            .then(data => {
                // Render data table
                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-gray-400 mb-3">
                                <i class="fas fa-inbox text-3xl"></i>
                            </div>
                            <h4 class="text-lg font-medium mb-2">No data yet</h4>
                            <p class="text-gray-500">Use the form to add some data.</p>
                        </div>
                    `;
                    return;
                }
                
                // Get column names from the first row
                const columns = Object.keys(data[0]);
                
                // Create table HTML
                let tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                `;
                
                // Add column headers
                columns.forEach(column => {
                    // Convert snake_case to Title Case for display
                    const displayName = column
                        .split('_')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                    
                    tableHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${displayName}</th>`;
                });
                
                // Add actions column
                tableHtml += `<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>`;
                
                tableHtml += `
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                // Add rows
                data.forEach(row => {
                    tableHtml += `<tr>`;
                    
                    // Add cells
                    columns.forEach(column => {
                        let displayValue = row[column] !== null ? row[column] : '';
                        
                        // Format boolean values
                        if (typeof displayValue === 'boolean') {
                            displayValue = displayValue ? 
                                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Yes</span>' : 
                                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">No</span>';
                        }
                        
                        tableHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayValue}</td>`;
                    });
                    
                    // Add actions
                    tableHtml += `
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-blue-500 hover:text-blue-700 mr-3" onclick="editRecord('${targetTable}', ${row.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700" onclick="deleteRecord('${targetTable}', ${row.id})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    
                    tableHtml += `</tr>`;
                });
                
                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML = tableHtml;
            })
            .catch(error => {
                console.error('Error:', error);
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-400 mb-3">
                            <i class="fas fa-exclamation-circle text-3xl"></i>
                        </div>
                        <h4 class="text-lg font-medium mb-2">Error</h4>
                        <p class="text-gray-500">Failed to load data. Please try again.</p>
                    </div>
                `;
            });
    }

    // Function to show a notification
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        
        let bgColor, textColor, icon;
        if (type === 'success') {
            bgColor = 'bg-green-50';
            textColor = 'text-green-800';
            icon = 'fa-check-circle';
        } else if (type === 'error') {
            bgColor = 'bg-red-50';
            textColor = 'text-red-800';
            icon = 'fa-exclamation-circle';
        } else {
            bgColor = 'bg-blue-50';
            textColor = 'text-blue-800';
            icon = 'fa-info-circle';
        }
        
        notification.className = `fixed top-4 right-4 ${bgColor} ${textColor} px-4 py-3 rounded-md shadow-md flex items-center transition-opacity duration-300`;
        notification.innerHTML = `
            <i class="fas ${icon} mr-2"></i>
            <span>${message}</span>
        `;
        
        // Add to document
        document.body.appendChild(notification);
        
        // Remove after delay
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Function to edit a record
    function editRecord(tableName, recordId) {
        alert(`Edit record ${recordId} in ${tableName} (Feature coming soon)`);
    }

    // Function to delete a record
    function deleteRecord(tableName, recordId) {
        if (confirm(`Are you sure you want to delete this record?`)) {
            fetch(`/modules/api/modules/${moduleId}/data/${tableName}/${recordId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete record');
                }
                
                showNotification('Record deleted successfully', 'success');
                
                // Refresh display sections
                loadDisplaySections();
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error deleting record', 'error');
            });
        }
    }

    // Get CSRF token for POST requests
    function getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return null;
    }
</script>
{% endblock %}